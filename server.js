import express from 'express';
import { createServer } from 'http';
import { Server } from 'socket.io';
import cors from 'cors';

const app = express();
const httpServer = createServer(app);

const corsOptions = {
    origin: '*',
    credentials: true,
    methods: ['GET', 'POST']
};

const io = new Server(httpServer, {
    cors: corsOptions,
    pingTimeout: 60000,
    pingInterval: 25000,
    transports: ['websocket', 'polling'],
    allowEIO3: true
});

app.use(cors(corsOptions));
app.use(express.json());

// ============ GAME STATE ============
const players = new Map();
const trades = new Map();

// ============ HTTP ROUTES ============
app.get('/', (req, res) => {
    res.send('üéÆ Touch World Server Online!');
});

app.get('/health', (req, res) => {
    res.json({
        status: 'healthy',
        players: players.size,
        trades: trades.size,
        timestamp: new Date().toISOString(),
        uptime: process.uptime()
    });
});

app.get('/stats', (req, res) => {
    const areaStats = {};
    for (const player of players.values()) {
        areaStats[player.areaId] = (areaStats[player.areaId] || 0) + 1;
    }
    res.json({
        totalPlayers: players.size,
        areaStats,
        activeTrades: trades.size
    });
});

// ============ SOCKET.IO EVENTS ============
io.on('connection', (socket) => {
    console.log('‚úÖ Player connected:', socket.id);

    // üéÆ JOIN - ◊©◊ó◊ß◊ü ◊†◊õ◊†◊°
    socket.on('join', (data) => {
        try {
            const { playerId, areaId, playerData } = data;
            if (!playerId || !areaId || !playerData) {
                console.warn('‚ö†Ô∏è Invalid join data');
                return;
            }

            const newPlayer = {
                id: playerId,
                socketId: socket.id,
                areaId: areaId,
                position_x: playerData.position_x || 960,
                position_y: playerData.position_y || 540,
                direction: playerData.direction || 'front',
                username: playerData.username,
                admin_level: playerData.admin_level || 'user',
                skin_code: playerData.skin_code || 'blue',
                equipped_hair: playerData.equipped_hair,
                equipped_top: playerData.equipped_top,
                equipped_pants: playerData.equipped_pants,
                equipped_hat: playerData.equipped_hat,
                equipped_halo: playerData.equipped_halo,
                equipped_necklace: playerData.equipped_necklace,
                equipped_accessories: playerData.equipped_accessories || [],
                is_invisible: playerData.is_invisible || false,
                animation_frame: 'idle',
                is_moving: false,
                joinedAt: Date.now(),
                lastUpdate: Date.now()
            };

            players.set(playerId, newPlayer);
            socket.join(areaId);

            // ◊©◊ú◊ó ◊©◊ó◊ß◊†◊ô◊ù ◊ß◊ô◊ô◊û◊ô◊ù ◊ú◊©◊ó◊ß◊ü ◊î◊ó◊ì◊©
            const playersInArea = Array.from(players.values())
                .filter(p => p.areaId === areaId && p.id !== playerId);
            
            socket.emit('currentPlayers', playersInArea);

            // ◊î◊ï◊ì◊¢ ◊ú◊©◊ó◊ß◊†◊ô◊ù ◊ê◊ó◊®◊ô◊ù ◊¢◊ú ◊©◊ó◊ß◊ü ◊ó◊ì◊©
            socket.to(areaId).emit('newPlayer', newPlayer);

            console.log('üë§ Player joined:', playerData.username, '| Area:', areaId, '| Total:', players.size);
        } catch (error) {
            console.error('‚ùå Join error:', error);
        }
    });

    // üö∂ MOVE - ◊™◊†◊ï◊¢◊™ ◊©◊ó◊ß◊ü
    socket.on('move', (data) => {
        try {
            const { playerId, x, y, direction, is_moving, animation_frame, username, admin_level, skin_code, equipped_hair, equipped_top, equipped_pants, equipped_hat, equipped_halo, equipped_necklace, equipped_accessories, is_invisible } = data;
            
            const player = players.get(playerId);
            if (player) {
                // ◊¢◊ì◊õ◊ü ◊ê◊™ ◊õ◊ú ◊î◊†◊™◊ï◊†◊ô◊ù
                player.position_x = x;
                player.position_y = y;
                player.direction = direction;
                player.is_moving = is_moving;
                player.animation_frame = animation_frame;
                player.username = username;
                player.admin_level = admin_level;
                player.skin_code = skin_code;
                player.equipped_hair = equipped_hair;
                player.equipped_top = equipped_top;
                player.equipped_pants = equipped_pants;
                player.equipped_hat = equipped_hat;
                player.equipped_halo = equipped_halo;
                player.equipped_necklace = equipped_necklace;
                player.equipped_accessories = equipped_accessories;
                player.is_invisible = is_invisible;
                player.lastUpdate = Date.now();

                // ◊©◊ì◊® ◊ú◊õ◊ú ◊î◊©◊ó◊ß◊†◊ô◊ù ◊ë◊ê◊ñ◊ï◊®
                socket.to(player.areaId).emit('playerMoved', player);
            }
        } catch (error) {
            console.error('‚ùå Move error:', error);
        }
    });

    // üö™ CHANGE AREA - ◊©◊ô◊†◊ï◊ô ◊ê◊ñ◊ï◊®
    socket.on('changeArea', (data) => {
        try {
            const { playerId, newAreaId } = data;
            const player = players.get(playerId);

            if (player) {
                const oldArea = player.areaId;
                
                // ◊¢◊ñ◊ï◊ë ◊ê◊ñ◊ï◊® ◊ô◊©◊ü
                socket.leave(oldArea);
                socket.to(oldArea).emit('playerLeft', { playerId });

                // ◊î◊¶◊ò◊®◊£ ◊ú◊ê◊ñ◊ï◊® ◊ó◊ì◊©
                socket.join(newAreaId);
                player.areaId = newAreaId;
                player.lastUpdate = Date.now();

                // ◊©◊ú◊ó ◊©◊ó◊ß◊†◊ô◊ù ◊ß◊ô◊ô◊û◊ô◊ù ◊ë◊ê◊ñ◊ï◊® ◊î◊ó◊ì◊©
                const playersInNewArea = Array.from(players.values())
                    .filter(p => p.areaId === newAreaId && p.id !== playerId);
                
                socket.emit('currentPlayers', playersInNewArea);

                // ◊î◊ï◊ì◊¢ ◊ú◊©◊ó◊ß◊†◊ô◊ù ◊ë◊ê◊ñ◊ï◊® ◊î◊ó◊ì◊©
                socket.to(newAreaId).emit('newPlayer', player);

                console.log('üö™ Area change:', player.username, oldArea, '‚Üí', newAreaId);
            }
        } catch (error) {
            console.error('‚ùå Area change error:', error);
        }
    });

    // üí¨ BUBBLE MESSAGE - ◊î◊ï◊ì◊¢◊™ ◊ë◊ï◊¢◊î
    socket.on('bubbleMessage', (data) => {
        try {
            const { playerId, message, username, adminLevel } = data;
            const player = players.get(playerId);

            if (player) {
                const messageData = {
                    playerId,
                    message,
                    username,
                    adminLevel,
                    timestamp: Date.now()
                };

                // ◊©◊ì◊® ◊ú◊õ◊ú ◊î◊©◊ó◊ß◊†◊ô◊ù ◊ë◊ê◊ñ◊ï◊® (◊õ◊ï◊ú◊ú ◊î◊©◊ï◊ú◊ó)
                io.to(player.areaId).emit('bubbleMessage', messageData);

                console.log('üí¨', username, ':', message.substring(0, 50));
            }
        } catch (error) {
            console.error('‚ùå Bubble error:', error);
        }
    });

    // ü§ù TRADE REQUEST - ◊ë◊ß◊©◊™ ◊ò◊®◊ô◊ì
    socket.on('tradeRequest', (data) => {
        try {
            const { tradeId, initiator_id, receiver_id } = data;
            const receiver = players.get(receiver_id);
            const initiator = players.get(initiator_id);

            if (receiver?.socketId) {
                io.to(receiver.socketId).emit('tradeRequest', {
                    tradeId,
                    initiator_id,
                    receiver_id,
                    initiator_username: initiator?.username
                });
                console.log('ü§ù Trade request:', initiator?.username, '‚Üí', receiver?.username);
            }
        } catch (error) {
            console.error('‚ùå Trade request error:', error);
        }
    });

    // üîÑ TRADE UPDATE - ◊¢◊ì◊õ◊ï◊ü ◊ò◊®◊ô◊ì
    socket.on('tradeUpdate', (data) => {
        try {
            const { tradeId, status } = data;
            trades.set(tradeId, { ...data, updatedAt: Date.now() });

            const trade = trades.get(tradeId);
            if (trade) {
                const initiator = players.get(trade.initiator_id);
                const receiver = players.get(trade.receiver_id);

                if (initiator?.socketId) {
                    io.to(initiator.socketId).emit('tradeUpdate', trade);
                }
                if (receiver?.socketId) {
                    io.to(receiver.socketId).emit('tradeUpdate', trade);
                }

                console.log('üîÑ Trade update:', tradeId, '‚Üí', status);

                if (['completed', 'cancelled'].includes(status)) {
                    trades.delete(tradeId);
                }
            }
        } catch (error) {
            console.error('‚ùå Trade update error:', error);
        }
    });

    // üèì PING/PONG - ◊ë◊ì◊ô◊ß◊™ ◊ó◊ô◊ë◊ï◊®
    socket.on('ping', () => {
        socket.emit('pong');
    });

    // ‚ùå DISCONNECT - ◊î◊™◊†◊™◊ß◊ï◊™
    socket.on('disconnect', (reason) => {
        console.log('‚ùå Player disconnected:', socket.id, '| Reason:', reason);

        let disconnectedPlayer = null;
        for (const [playerId, player] of players.entries()) {
            if (player.socketId === socket.id) {
                disconnectedPlayer = player;
                players.delete(playerId);
                socket.to(player.areaId).emit('playerLeft', { playerId });
                break;
            }
        }

        if (disconnectedPlayer) {
            const duration = Math.round((Date.now() - disconnectedPlayer.joinedAt) / 1000);
            console.log('üëã Removed:', disconnectedPlayer.username, '| Duration:', duration, 's | Remaining:', players.size);
        }
    });

    // ‚ö†Ô∏è ERROR
    socket.on('error', (error) => {
        console.error('‚ö†Ô∏è Socket error:', socket.id, error);
    });
});

// ============ CLEANUP TASKS ============
setInterval(() => {
    const now = Date.now();
    const timeout = 120000; // 2 minutes

    for (const [playerId, player] of players.entries()) {
        if (now - player.lastUpdate > timeout) {
            console.log('üßπ Removing inactive player:', player.username);
            players.delete(playerId);
            io.to(player.areaId).emit('playerLeft', { playerId });
        }
    }
}, 60000); // Run every 60 seconds

// ============ STATS LOGGING ============
setInterval(() => {
    const areaStats = {};
    for (const player of players.values()) {
        areaStats[player.areaId] = (areaStats[player.areaId] || 0) + 1;
    }
    console.log('üìä Stats | Players:', players.size, '| Trades:', trades.size, '| Areas:', areaStats);
}, 300000); // Every 5 minutes

// ============ ERROR HANDLING ============
app.use((err, req, res, next) => {
    console.error('‚ùå Express error:', err);
    res.status(500).json({ error: 'Internal server error' });
});

// ============ START SERVER ============
const PORT = process.env.PORT || 3001;

httpServer.listen(PORT, () => {
    console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   üéÆ TOUCH WORLD SERVER ONLINE v2.0          ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  Port: ${PORT}                                  ‚ïë
‚ïë  Environment: ${process.env.NODE_ENV || 'dev'} ‚ïë
‚ïë  WebSocket: Enabled ‚úÖ                        ‚ïë
‚ïë  Multiplayer: Active ‚úÖ                       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    `);
});

export { io, app };
